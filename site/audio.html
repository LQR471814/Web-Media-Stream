<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>Audio Test</title>

  <script type="text/javascript">
    async function onIceCandidate(conn, e) {
      try {
        await (peerConnection.addIceCandidate(e.candidate))
      } catch (e) {
        console.log("Failed to add Ice candidate.")
      }
    }

    function onIceStateChange(conn, e) {
      console.log(conn.iceConnectionState)
    }

    async function getMedia(constraints) {
      var offerOptions = {
        offerToReceiveAudio: 1,
        offerToReceiveVideo: 1
      }

      let stream = null;
      var signalling = new WebSocket("https://192.168.1.8")

      try {
        console.log("Initializing audio...")
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        track = stream.getAudioTracks()[0]
      } catch(err) {
        console.log(err)
        alert("Something went wrong while trying to get user media: " + err)
        return
      }

      console.log("Initializing connection...")
      var peerConnection = new RTCPeerConnection()
      peerConnection.addEventListener('icecandidate', e => onIceCandidate(peerConnection, e))
      peerConnection.addEventListener('iceconnectionstatechange', e => onIceStateChange(peerConnection, e))
      stream.getTracks().forEach(track => peerConnection.addTrack(track, stream))

      try {
        console.log("Creating offer...")
        const offer = await peerConnection.createOffer(offerOptions)

        await peerConnection.setLocalDescription(offer)
        console.log(offer.sdp)
        console.log(offer.toJSON())
      } catch (e) {
        console.log("Failed to create session description " + e)
      }
    }
    getMedia({audio: true, video: false})
  </script>

</head>

<body>

  <canvas id="c"></canvas>

</body>

</html>